#!/usr/bin/env node

/*
Copyright (c) 2013, Yahoo! Inc. All rights reserved.
Code licensed under the BSD License:
http://yuilibrary.com/license/
*/

var checker = require('../lib/index');
const isValidLicense = require("spdx-expression-validate");
const isSatisfiedLicense = require("spdx-satisfies");
const correct = require('spdx-correct')

var args = require('../lib/args').parse();
var path = require('path');

if (args.help) {
    console.error('license-checker@' + require('../package.json').version);
    var usage = [
        '',
        '   --start [path of the initial json to look for]',
        '   --csv output in csv format.',
        '',
        '   --version The current version',
        '   --help  The text you are reading right now :)',
        ''
    ];
    console.error(usage.join('\n'), '\n');
    process.exit(0);
}

if (args.version) {
    console.error(require('../package.json').version);
    process.exit(1);
}

const config = require(path.resolve(args.start, 'package.json'))['license-checker']
if (!config || !config.allow) {
    console.error('Missing required "license-checker.allow" config in ./package.json');
    process.exit(1);
}
const {allow, override = {}} = config;

checker.init({
    ...args,
    excludePrivatePackages: true
}, function(err, packages) {
    if (err) {
      console.error(err);
      process.exit(1);
    } else {
      const infos = Object.entries(packages).map(([key, {licenses, repository, path}]) => {
        let licenseName = Array.isArray(licenses) ? licenses.join(' OR ') : licenses;
        const over = override[key];
        if (over && over.licenseName) {
          licenseName = over.licenseName;
        }
        if (licenseName.endsWith('*')) licenseName = licenseName.slice(0, -1);
        if (!isValidLicense(licenseName)) {
          licenseName = correct(licenseName)
        }
        if (!repository) repository = `https://www.npmjs.com/package/${key.replace(/(.)@/, '$1/v/')}`
        return {
          key, licenseName, repository, path
        }
      });
      if (args.csv) {
        console.log(`"Name@Version","License","Url"`)
        infos.sort((a,b) => `${a.key}`.localeCompare(`${b.key}`)).map(({key, licenseName, repository}) => `"${key}","${licenseName}","${repository}"`).forEach(it => console.log(it))
      }
      const errors = getLicenseViolations(infos, allow)
      if (errors.length) {
        console.error(`License check errors:`, errors)
        process.exit(1);
      } else {
        process.exit(0);
      }
    }
});

const getLicenseViolations = (licenseInformation, allow) => {
  return licenseInformation.reduce((memo, { key, licenseName, path }) => {
    if (!licenseName || licenseName === "UNLICENSED") {
      memo.push(`${key} is unlicensed (${path})`);
    } else if (!isValidLicense(licenseName)) {
      memo.push(`${key} has invalid license ${licenseName} (${path})`);
    } else if (!isSatisfiedLicense(licenseName, allow)) {
      memo.push(`${key} has disallowed license ${licenseName} (${path})`);
    }
    return memo;
  }, []);
};
